<html>
<!-- 
python3 -m http.server --bind 127.0.0.1 8000 
-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body>
    <h1>Embedded Games Tester</h1>

    <div class="row">
        <form>
            <label for="backend-select">Choose backend:</label>
            <select id="backend-select" class="form-select mb-3" aria-describedby="backend-select-help">
                <option value="http://127.0.0.1:4000/api/" selected="true">http://127.0.0.1:4000/api/ (local)</option>
                <option value="https://devgame-api-v2.xoob.gg/api/">https://devgame-api-v2.xoob.gg/api/ (test)</option>
                <option value="https://game-api-v2.xoob.gg/api/">https://game-api-v2.xoob.gg/api/ (prod)</option>
            </select>
            <div id="backend-select-help" class="form-text">TBD</div>

            <div class="mb-3">
                <label for="auth-token" class="form-label">Set Authorization Bearer</label>
                <input type="text" class="form-control" id="auth-token" aria-describedby="auth-token-help">
                <div id="auth-token-help" class="form-text">TBD</div>
            </div>


            <label for="game-select">Choose a game:</label>
            <select id="game-select" class="form-select mb-3" aria-describedby="game-select-help">
                <option value="1" selected="true">Rocket 1</option>
                <option value="2">Rocket 2</option>
            </select>
            <div id="game-select-help" class="form-text">TBD</div>

            <button id="launch-button" onclick="javascript:onClickLaunch()">Launch</button>
        </form>
    </div>

    <div class="row">
        <div class="col-4"></div>
        <div class="col-4" id="game-iframe-target"></div>
        <div class="col-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script type="text/javascript">
        function createFrame(iframeURL, targetElement) {
            var iframeElement = document.createElement("iframe");
            iframeElement.setAttribute("src", iframeURL);
            iframeElement.style.width = "640px";
            iframeElement.style.height = "480px";
            targetElement.appendChild(iframeElement);
        }

        function listGames() {
        }

        async function openGame(backendUrl, authorizationToken, gameId) {
            const startGameInfoResponse = await fetch(new URL(`embedded-games/${encodeURIComponent(gameId)}/new`, backendUrl), {
                method: "POST",
                headers: new Headers({
                    'Authorization': `Bearer ${authorizationToken}`,
                    // 'Content-Type': 'application/json; charset=utf-8',
                    'Accept': 'application/json; charset=utf-8',
                }),
                // body: JSON.stringify({}),
            });

            if (!startGameInfoResponse.ok) {
                throw new Error(`${startGameInfoResponse.status} ${startGameInfoResponse.statusText}. Type: ${startGameInfoResponse.type}`);
            }

            const startGameInfo = await startGameInfoResponse.json();
            const { url: iframeGameUrl } = startGameInfo;

            return iframeGameUrl;
        }

        function onClickLaunch() {
            const authTokenInputElement = document.getElementById('auth-token');
            const launchButtonElement = document.getElementById('launch-button');
            const gameSelectElement = document.getElementById('game-select');
            const gameFrameTarget = document.getElementById('game-iframe-target');
            const backendSelectElement = document.getElementById('backend-select');


            const authorizationToken = authTokenInputElement.value;
            const gameId = gameSelectElement.value;
            const backendUrl = backendSelectElement.value;

            const buttonTextContentBackup = launchButtonElement.textContent;

            launchButtonElement.disabled = true;
            launchButtonElement.textContent = "Loading ...";

            openGame(backendUrl, authorizationToken, gameId)
                .then(function (iframeGameUrl) {
                    createFrame(iframeGameUrl, gameFrameTarget);
                })
                .catch(function (e) {
                    alert(`Unable to launch the game. See console log for details.`);
                    console.error(e);
                })
                .finally(function () {
                    launchButtonElement.disabled = false;
                    launchButtonElement.textContent = buttonTextContentBackup;
                });
        }
    </script>
</body>

</html>